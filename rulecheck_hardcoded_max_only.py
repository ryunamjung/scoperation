from __future__ import annotations

import io
import re
from datetime import datetime
from typing import Dict, List, Set

import pandas as pd
import streamlit as st


# ============================================================
# ✅ 하드코딩 RULES (규칙결과 엑셀 -> case_n > 1만 포함)
# ============================================================
RULES: Dict[str, dict] = {'MZ001': {'base_col': '청구코드',
           'case_n_max': 9,
           'rules_0401': [{'case_n': 9,
                           '급비': '0',
                           '단가': '321',
                           '동반(모든케이스)': True,
                           '처방코드': '64490269',
                           '청구코드': '644902691',
                           '코드': '644902691',
                           '코드명': '[331]중외생리식염주사액(20ml)',
                           '항목': '0401'},
                          {'case_n': 9,
                           '급비': '0',
                           '단가': '0',
                           '동반(모든케이스)': True,
                           '처방코드': '65780445',
                           '청구코드': '657804451',
                           '코드': '657804451',
                           '코드명': '[121]로카핀주7.5mg/ml(로피바카인염산염수화물)_(0.158g/20ml)',
                           '항목': '0401'}],
           'rules_0801': [{'case_n': 9,
                           '급비': '3',
                           '단가': '30,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'BM5100DCN',
                           '청구코드': 'BM5100DC',
                           '코드': 'BM5100DC',
                           '코드명': '인성부직반창고 나잘',
                           '항목': '0801'},
                          {'case_n': 9,
                           '급비': '3',
                           '단가': '600,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'MZ001A',
                           '청구코드': 'MZ001',
                           '코드': 'MZ001',
                           '코드명': 'FIMS-(V)',
                           '항목': '0801'}]},
 'N0471': {'base_col': '청구코드',
           'case_n_max': 5,
           'rules_0401': [{'case_n': 5,
                           '급비': '0',
                           '단가': '321',
                           '동반(모든케이스)': True,
                           '처방코드': '64490269',
                           '청구코드': '644902691',
                           '코드': '644902691',
                           '코드명': '[331]중외생리식염주사액(20ml)',
                           '항목': '0401'},
                          {'case_n': 5,
                           '급비': '0',
                           '단가': '0',
                           '동반(모든케이스)': True,
                           '처방코드': '654802PE',
                           '청구코드': '(654802PE)',
                           '코드': '(654802PE)',
                           '코드명': '액상하이랙스주 750 I.U/0.5ml (PEN-무수가)',
                           '항목': '0401'},
                          {'case_n': 5,
                           '급비': '3',
                           '단가': '0',
                           '동반(모든케이스)': True,
                           '처방코드': '6706034A',
                           '청구코드': '(6706034A)',
                           '코드': '(6706034A)',
                           '코드명': '[121]휴온스리도카인1 %20ml(PEN-무수가)',
                           '항목': '0401'},
                          {'case_n': 5,
                           '급비': '3',
                           '단가': '50,000',
                           '동반(모든케이스)': True,
                           '처방코드': '059600681',
                           '청구코드': '059600681',
                           '코드': '059600681',
                           '코드명': '[245]리포타손 주 4mg/1ml(5)',
                           '항목': '0401'},
                          {'case_n': 5,
                           '급비': '3',
                           '단가': '0',
                           '동반(모든케이스)': True,
                           '처방코드': 'BMIDAA',
                           '청구코드': '642200701',
                           '코드': '642200701',
                           '코드명': '[향]*부광미다졸람 5mg/5ml (PEN-무수가)',
                           '항목': '0401'},
                          {'case_n': 5,
                           '급비': '0',
                           '단가': '5,778',
                           '동반(모든케이스)': True,
                           '처방코드': '64370027',
                           '청구코드': '643700271',
                           '코드': '643700271',
                           '코드명': '[618]국제세파제돈주1g(세파제돈나트륨)',
                           '항목': '0401'},
                          {'case_n': 5,
                           '급비': '3',
                           '단가': '100,000',
                           '동반(모든케이스)': True,
                           '처방코드': '6489033SC',
                           '청구코드': '648903331',
                           '코드': '648903331',
                           '코드명': '(척추진정)프리세덱스프리믹스주 20ml',
                           '항목': '0401'},
                          {'case_n': 5,
                           '급비': '3',
                           '단가': '0',
                           '동반(모든케이스)': True,
                           '처방코드': '65780229',
                           '청구코드': '657802271',
                           '코드': '657802271',
                           '코드명': '[마]*하나구연산펜타닐 0.157mg/2ml (PEN-무수가)',
                           '항목': '0401'},
                          {'case_n': 5,
                           '급비': '3',
                           '단가': '0',
                           '동반(모든케이스)': True,
                           '처방코드': '65780445N',
                           '청구코드': '657804451',
                           '코드': '657804451',
                           '코드명': '[121]PEN용 로카핀주7.5mg/ml_(0.158g/20ml)',
                           '항목': '0401'},
                          {'case_n': 5,
                           '급비': '3',
                           '단가': '0',
                           '동반(모든케이스)': True,
                           '처방코드': 'A0456B',
                           '청구코드': '657804561',
                           '코드': '657804561',
                           '코드명': '[111][향]아네폴주사(프로포폴)_(50mg/5mL)(PEN-무수가)',
                           '항목': '0401'},
                          {'case_n': 5,
                           '급비': '0',
                           '단가': '0',
                           '동반(모든케이스)': True,
                           '처방코드': 'IX',
                           '청구코드': 'IX',
                           '코드': 'IX',
                           '코드명': '수기료 산정안함',
                           '항목': '0401'},
                          {'case_n': 5,
                           '급비': '0',
                           '단가': '3,920',
                           '동반(모든케이스)': True,
                           '처방코드': 'KK053',
                           '청구코드': 'KK053',
                           '코드': 'KK053',
                           '코드명': 'Fluid-501-1000mL',
                           '항목': '0401'},
                          {'case_n': 5,
                           '급비': '0',
                           '단가': '1,440',
                           '동반(모든케이스)': True,
                           '처방코드': 'KK054',
                           '청구코드': 'KK054',
                           '코드': 'KK054',
                           '코드명': 'IV side',
                           '항목': '0401'}],
           'rules_0801': [{'case_n': 5,
                           '급비': '0',
                           '단가': '11',
                           '동반(모든케이스)': True,
                           '처방코드': 'OXY02',
                           '청구코드': '699900020',
                           '코드': '699900020',
                           '코드명': '처치용산소 2L',
                           '항목': '0801'},
                          {'case_n': 5,
                           '급비': '3',
                           '단가': '150,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'BC1229RG',
                           '청구코드': 'BC1229RG',
                           '코드': 'BC1229RG',
                           '코드명': 'LSO보조기(요추)',
                           '항목': '0801'},
                          {'case_n': 5,
                           '급비': '3',
                           '단가': '1,000,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'BJ4801UN',
                           '청구코드': 'BJ4801UN',
                           '코드': 'BJ4801UN',
                           '코드명': 'spinaut catheter(요추) L-PEN',
                           '항목': '0801'},
                          {'case_n': 5,
                           '급비': '3',
                           '단가': '30,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'BK7000VB',
                           '청구코드': 'BK7000VB',
                           '코드': 'BK7000VB',
                           '코드명': 'BBAND (아이비메디칼)',
                           '항목': '0801'},
                          {'case_n': 5,
                           '급비': '3',
                           '단가': '30,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'BM5100DCN',
                           '청구코드': 'BM5100DC',
                           '코드': 'BM5100DC',
                           '코드명': '인성부직반창고 나잘',
                           '항목': '0801'},
                          {'case_n': 5,
                           '급비': '0',
                           '단가': '88,650',
                           '동반(모든케이스)': True,
                           '처방코드': 'E5100051',
                           '청구코드': 'E5100070',
                           '코드': 'E5100070',
                           '코드명': 'Spinofill (아이비메디칼)',
                           '항목': '0801'},
                          {'case_n': 5,
                           '급비': '0',
                           '단가': '57,430',
                           '동반(모든케이스)': True,
                           '처방코드': 'F1401004',
                           '청구코드': 'F1401004',
                           '코드': 'F1401004',
                           '코드명': 'VP needle (아이비메디칼)',
                           '항목': '0801'},
                          {'case_n': 5,
                           '급비': '0',
                           '단가': '8,720',
                           '동반(모든케이스)': True,
                           '처방코드': 'M0040',
                           '청구코드': 'M0040',
                           '코드': 'M0040',
                           '코드명': 'O2 Inhalation(산소흡입)-1일당',
                           '항목': '0801'},
                          {'case_n': 5,
                           '급비': 'B',
                           '단가': '143',
                           '동반(모든케이스)': True,
                           '처방코드': 'M3101027',
                           '청구코드': 'M3101127',
                           '코드': 'M3101127',
                           '코드명': '큐앤큐메딕스밴드 부직포+탈지면패드 6*8 [1호]',
                           '항목': '0801'},
                          {'case_n': 5,
                           '급비': '0',
                           '단가': '272,740',
                           '동반(모든케이스)': True,
                           '처방코드': 'N0471',
                           '청구코드': 'N0471',
                           '코드': 'N0471',
                           '코드명': 'Vertebroplasty(VP)-1부위(경피적 척추 성형술-1부위)',
                           '항목': '0801'},
                          {'case_n': 5,
                           '급비': '3',
                           '단가': '1,100,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'SZ634A',
                           '청구코드': 'SZ634',
                           '코드': 'SZ634',
                           '코드명': 'PEN -Lumbar(경피적 경막외강 신경성형술)',
                           '항목': '0801'}]},
 'N1494': {'base_col': '청구코드',
           'case_n_max': 2,
           'rules_0401': [{'case_n': 2,
                           '급비': '0',
                           '단가': '620',
                           '동반(모든케이스)': True,
                           '처방코드': '65050034',
                           '청구코드': '650500341',
                           '코드': '650500341',
                           '코드명': '[121]제일리도카인2%주(0.4g/20ml)',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '1,304',
                           '동반(모든케이스)': True,
                           '처방코드': '64000107',
                           '청구코드': '640001071',
                           '코드': '640001071',
                           '코드명': '[331]이노엔0.9%생리식염주사액(100ml)',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '3',
                           '단가': '50,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'PINJ05',
                           '청구코드': '(PINJ05)',
                           '코드': '(PINJ05)',
                           '코드명': '통증주사',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '4,962',
                           '동반(모든케이스)': True,
                           '처방코드': '64000171',
                           '청구코드': '640001711',
                           '코드': '640001711',
                           '코드명': '[339]이노엔생리식염관주액(3000ml)',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '4,815',
                           '동반(모든케이스)': True,
                           '처방코드': '64000261',
                           '청구코드': '640002610',
                           '코드': '640002610',
                           '코드명': '[331]플라스마솔루션에이주(1000ml)',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '1,675',
                           '동반(모든케이스)': True,
                           '처방코드': '64000268',
                           '청구코드': '640002680',
                           '코드': '640002680',
                           '코드명': '[331]이노엔하트만액 1000ml',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '1',
                           '단가': '18,475',
                           '동반(모든케이스)': True,
                           '처방코드': 'BNSR',
                           '청구코드': '641906121',
                           '코드': '641906121',
                           '코드명': '[235]나제론주사액0.3mg(0.3mg/2ml)',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '3',
                           '단가': '120,000',
                           '동반(모든케이스)': True,
                           '처방코드': '64190786',
                           '청구코드': '641907861',
                           '코드': '641907861',
                           '코드명': '브레스온주 2ml (보령제약)',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '211',
                           '동반(모든케이스)': True,
                           '처방코드': 'AQU1',
                           '청구코드': '645100643',
                           '코드': '645100643',
                           '코드명': '[713]대한멸균증류수20ml(앰플,PP)-대한약품*',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '480',
                           '동반(모든케이스)': True,
                           '처방코드': '64850236',
                           '청구코드': '648502361',
                           '코드': '648502361',
                           '코드명': '[332]*트라넥삼산주사500mg-신풍제약(주)',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '700',
                           '동반(모든케이스)': True,
                           '처방코드': 'BMBN',
                           '청구코드': '649800971',
                           '코드': '649800971',
                           '코드명': '[123]명문모비눌주0.2mg/1ml(글리코피롤레이트)',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '4,626',
                           '동반(모든케이스)': True,
                           '처방코드': '64980438',
                           '청구코드': '649804381',
                           '코드': '649804381',
                           '코드명': '[235]*오트론주(온단세트론염산염수화물)(수출명:명문온단세트론주사)_(5mg/2ml) 급여명문제약(주)',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '338',
                           '동반(모든케이스)': True,
                           '처방코드': 'A00421',
                           '청구코드': '650500421',
                           '코드': '650500421',
                           '코드명': '[245]*제일에피네프린주사액',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '349',
                           '동반(모든케이스)': True,
                           '처방코드': 'BLSX',
                           '청구코드': '652100211',
                           '코드': '652100211',
                           '코드명': '[213]*라식스주사 20mg (한독)',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '3',
                           '단가': '0',
                           '동반(모든케이스)': True,
                           '처방코드': '65310070F',
                           '청구코드': '653100701',
                           '코드': '653100701',
                           '코드명': '[611](OR용-FREE)비씨반코마이신염산염주1g',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '300',
                           '동반(모든케이스)': True,
                           '처방코드': '653101191',
                           '청구코드': '653101191',
                           '코드': '653101191',
                           '코드명': '[222]아록솔주(암브록솔염산염)_(15mg/2mL)',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '1,812',
                           '동반(모든케이스)': True,
                           '처방코드': 'A0235',
                           '청구코드': '653402351',
                           '코드': '653402351',
                           '코드명': '[111][향]포폴주사12ml(프로포폴)',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '3',
                           '단가': '40,000',
                           '동반(모든케이스)': True,
                           '처방코드': '65480211',
                           '청구코드': '654802110',
                           '코드': '654802110',
                           '코드명': '액상하이랙스주 750 I.U/0.5ml',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '3,174',
                           '동반(모든케이스)': True,
                           '처방코드': '65540296',
                           '청구코드': '655402961',
                           '코드': '655402961',
                           '코드명': '[122]로큐메론주50mg/5ml(로쿠로니움브롬화물)',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '1',
                           '단가': '2,071',
                           '동반(모든케이스)': True,
                           '처방코드': '65780227',
                           '청구코드': '657802273',
                           '코드': '657802273',
                           '코드명': '[821][마]하나구연산펜타닐주0.157mg/2ml',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '1',
                           '단가': '9,954',
                           '동반(모든케이스)': True,
                           '처방코드': '65780228',
                           '청구코드': '657802283',
                           '코드': '657802283',
                           '코드명': '[821][마]하나구연산펜타닐주사(10ml/앰플(P)',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '5,338',
                           '동반(모든케이스)': True,
                           '처방코드': '65780445',
                           '청구코드': '657804451',
                           '코드': '657804451',
                           '코드명': '[121]로카핀주7.5mg/ml(로피바카인염산염수화물)_(0.158g/20ml)',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '3',
                           '단가': '120,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'NDNAPL',
                           '청구코드': '662800061',
                           '코드': '662800061',
                           '코드명': '신경손상DNA-플라센텍스주',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '3',
                           '단가': '0',
                           '동반(모든케이스)': True,
                           '처방코드': '67060263',
                           '청구코드': '670602631',
                           '코드': '670602631',
                           '코드명': '하이코민주사 2ml(fee free-하부코드전용)',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '641',
                           '동반(모든케이스)': True,
                           '처방코드': '67060346',
                           '청구코드': '670603464',
                           '코드': '670603464',
                           '코드명': '[121]휴온스리도카인1%주(0.2134g/20ml)',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '3',
                           '단가': '0',
                           '동반(모든케이스)': True,
                           '처방코드': '6932AAP',
                           '청구코드': '681100401',
                           '코드': '681100401',
                           '코드명': '(fee free-하부코드전용)GCW아세트아미노펜주',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '0',
                           '동반(모든케이스)': True,
                           '처방코드': 'IX',
                           '청구코드': 'IX',
                           '코드': 'IX',
                           '코드명': '수기료 산정안함',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '3,220',
                           '동반(모든케이스)': True,
                           '처방코드': 'KK052',
                           '청구코드': 'KK052',
                           '코드': 'KK052',
                           '코드명': 'Fluid-100-500mL',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '3,920',
                           '동반(모든케이스)': True,
                           '처방코드': 'KK053',
                           '청구코드': 'KK053',
                           '코드': 'KK053',
                           '코드명': 'Fluid-501-1000mL',
                           '항목': '0401'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '1,440',
                           '동반(모든케이스)': True,
                           '처방코드': 'KK054',
                           '청구코드': 'KK054',
                           '코드': 'KK054',
                           '코드명': 'IV side',
                           '항목': '0401'}],
           'rules_0801': [{'case_n': 2,
                           '급비': '3',
                           '단가': '2,000,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'BJ4802UN',
                           '청구코드': 'BJ4802UN',
                           '코드': 'BJ4802UN',
                           '코드명': 'Spinaut-V Epidural Catheter(아이비메디칼)',
                           '항목': '0801'},
                          {'case_n': 2,
                           '급비': '3',
                           '단가': '30,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'BK7000VB',
                           '청구코드': 'BK7000VB',
                           '코드': 'BK7000VB',
                           '코드명': 'BBAND (아이비메디칼)',
                           '항목': '0801'},
                          {'case_n': 2,
                           '급비': '3',
                           '단가': '12,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'BK7000ZC',
                           '청구코드': 'BK7000ZC',
                           '코드': 'BK7000ZC',
                           '코드명': 'MEDIAS T (아이비메디칼)',
                           '항목': '0801'},
                          {'case_n': 2,
                           '급비': '3',
                           '단가': '4,950',
                           '동반(모든케이스)': True,
                           '처방코드': 'BM2000JI',
                           '청구코드': 'BM2000JI',
                           '코드': 'BM2000JI',
                           '코드명': 'Tape silicone(innomed) 2.5*30cm (비즈메디)',
                           '항목': '0801'},
                          {'case_n': 2,
                           '급비': '3',
                           '단가': '30,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'BM5100DCM',
                           '청구코드': 'BM5100DC',
                           '코드': 'BM5100DC',
                           '코드명': '인성부직반창고 마스크',
                           '항목': '0801'},
                          {'case_n': 2,
                           '급비': '3',
                           '단가': '30,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'BM5101JN',
                           '청구코드': 'BM5100JN',
                           '코드': 'BM5100JN',
                           '코드명': 'VS 밴드 (아이비메디칼)',
                           '항목': '0801'},
                          {'case_n': 2,
                           '급비': 'B',
                           '단가': '54,150',
                           '동반(모든케이스)': True,
                           '처방코드': 'J4306735',
                           '청구코드': 'J4306735',
                           '코드': 'J4306735',
                           '코드명': 'Autofuser K Bolus (PCA )(아이비메디칼)',
                           '항목': '0801'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '17,160',
                           '동반(모든케이스)': True,
                           '처방코드': 'K3002304',
                           '청구코드': 'K3002304',
                           '코드': 'K3002304',
                           '코드명': 'Barovac-Pp (세운)',
                           '항목': '0801'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '1,290',
                           '동반(모든케이스)': True,
                           '처방코드': 'K3100005',
                           '청구코드': 'K3100105',
                           '코드': 'K3100105',
                           '코드명': 'Urine Bag (비즈메디)',
                           '항목': '0801'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '14,820',
                           '동반(모든케이스)': True,
                           '처방코드': 'K4041031',
                           '청구코드': 'K4041031',
                           '코드': 'K4041031',
                           '코드명': 'E-Tube Reinforced Cuffed Type(꺽임방지형)(전규격)(비즈메디)',
                           '항목': '0801'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '15,750',
                           '동반(모든케이스)': True,
                           '처방코드': 'K4430035',
                           '청구코드': 'K4430035',
                           '코드': 'K4430035',
                           '코드명': 'ACE BLADE(비전메디)',
                           '항목': '0801'},
                          {'case_n': 2,
                           '급비': 'B',
                           '단가': '57,070',
                           '동반(모든케이스)': True,
                           '처방코드': 'K4501361',
                           '청구코드': 'K4501361',
                           '코드': 'K4501361',
                           '코드명': 'HEATED CIRCUIT',
                           '항목': '0801'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '3,790',
                           '동반(모든케이스)': True,
                           '처방코드': 'K5001003',
                           '청구코드': 'K5001504',
                           '코드': 'K5001504',
                           '코드명': 'Foley Cath(14fr/16Fr/18 Fr)(비즈메디)',
                           '항목': '0801'},
                          {'case_n': 2,
                           '급비': '3',
                           '단가': '100,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'K9205250',
                           '청구코드': 'K9205250',
                           '코드': 'K9205250',
                           '코드명': 'M-Clot [전규격]',
                           '항목': '0801'},
                          {'case_n': 2,
                           '급비': 'B',
                           '단가': '43,730',
                           '동반(모든케이스)': True,
                           '처방코드': 'L9002003',
                           '청구코드': 'L9002003',
                           '코드': 'L9002003',
                           '코드명': 'Bis Xp Platform Polyester 등 (전신마취시)(큐메딕스)',
                           '항목': '0801'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '12,380',
                           '동반(모든케이스)': True,
                           '처방코드': 'M0060',
                           '청구코드': 'M0060',
                           '코드': 'M0060',
                           '코드명': 'Foley Catheterization',
                           '항목': '0801'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '7,580',
                           '동반(모든케이스)': True,
                           '처방코드': 'M6610161',
                           '청구코드': 'M6610161',
                           '코드': 'M6610161',
                           '코드명': 'ACE GRIP ENDO FIXⅡ',
                           '항목': '0801'},
                          {'case_n': 2,
                           '급비': 'B',
                           '단가': '1,500',
                           '동반(모든케이스)': True,
                           '처방코드': 'M6710639',
                           '청구코드': 'M6710639',
                           '코드': 'M6710639',
                           '코드명': 'Multifix EF(폴리용)(유치카테터 고정용)(비즈메디)',
                           '항목': '0801'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '160,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'N0031004',
                           '청구코드': 'N0031004',
                           '코드': 'N0031004',
                           '코드명': '내시경하 추간판제거술시 사용하는 치료재료 비용',
                           '항목': '0801'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '45,390',
                           '동반(모든케이스)': True,
                           '처방코드': 'N0101512',
                           '청구코드': 'N0101512',
                           '코드': 'N0101512',
                           '코드명': '수술팩(Ⅱ)(마취시간 1시간초과~3시간이하)',
                           '항목': '0801'},
                          {'case_n': 2,
                           '급비': '0',
                           '단가': '523,080',
                           '동반(모든케이스)': True,
                           '처방코드': 'N1494',
                           '청구코드': 'N1494',
                           '코드': 'N1494',
                           '코드명': 'Diskectomy-by endoscopy(추간판제거술-내시경하)',
                           '항목': '0801'},
                          {'case_n': 2,
                           '급비': '3',
                           '단가': '3,000,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'SZ6313',
                           '청구코드': 'SZ631',
                           '코드': 'SZ631',
                           '코드명': 'EED (내시경적 경막외강 신경감압술)',
                           '항목': '0801'}]},
 'N1499': {'base_col': '청구코드',
           'case_n_max': 16,
           'rules_0401': [{'case_n': 16,
                           '급비': '0',
                           '단가': '321',
                           '동반(모든케이스)': True,
                           '처방코드': '64490269',
                           '청구코드': '644902691',
                           '코드': '644902691',
                           '코드명': '[331]중외생리식염주사액(20ml)',
                           '항목': '0401'},
                          {'case_n': 16,
                           '급비': '1',
                           '단가': '2,071',
                           '동반(모든케이스)': True,
                           '처방코드': '65780227',
                           '청구코드': '657802273',
                           '코드': '657802273',
                           '코드명': '[821][마]하나구연산펜타닐주0.157mg/2ml',
                           '항목': '0401'},
                          {'case_n': 16,
                           '급비': '0',
                           '단가': '1,304',
                           '동반(모든케이스)': True,
                           '처방코드': '64000107',
                           '청구코드': '640001071',
                           '코드': '640001071',
                           '코드명': '[331]이노엔0.9%생리식염주사액(100ml)',
                           '항목': '0401'},
                          {'case_n': 16,
                           '급비': '1',
                           '단가': '18,475',
                           '동반(모든케이스)': True,
                           '처방코드': 'BNSR',
                           '청구코드': '641906121',
                           '코드': '641906121',
                           '코드명': '[235]나제론주사액0.3mg(0.3mg/2ml)',
                           '항목': '0401'},
                          {'case_n': 16,
                           '급비': '3',
                           '단가': '120,000',
                           '동반(모든케이스)': True,
                           '처방코드': '64190786',
                           '청구코드': '641907861',
                           '코드': '641907861',
                           '코드명': '브레스온주 2ml (보령제약)',
                           '항목': '0401'},
                          {'case_n': 16,
                           '급비': '3',
                           '단가': '0',
                           '동반(모든케이스)': True,
                           '처방코드': 'A0341',
                           '청구코드': '645100341',
                           '코드': '645100341',
                           '코드명': '[349](OR용)대한관류용멸균생리식염수_(9g/1000mL)',
                           '항목': '0401'},
                          {'case_n': 16,
                           '급비': '0',
                           '단가': '211',
                           '동반(모든케이스)': True,
                           '처방코드': 'AQU1',
                           '청구코드': '645100643',
                           '코드': '645100643',
                           '코드명': '[713]대한멸균증류수20ml(앰플,PP)-대한약품*',
                           '항목': '0401'},
                          {'case_n': 16,
                           '급비': '0',
                           '단가': '700',
                           '동반(모든케이스)': True,
                           '처방코드': 'BMBN',
                           '청구코드': '649800971',
                           '코드': '649800971',
                           '코드명': '[123]명문모비눌주0.2mg/1ml(글리코피롤레이트)',
                           '항목': '0401'},
                          {'case_n': 16,
                           '급비': '0',
                           '단가': '4,626',
                           '동반(모든케이스)': True,
                           '처방코드': '64980438',
                           '청구코드': '649804381',
                           '코드': '649804381',
                           '코드명': '[235]*오트론주(온단세트론염산염수화물)(수출명:명문온단세트론주사)_(5mg/2ml) 급여명문제약(주)',
                           '항목': '0401'},
                          {'case_n': 16,
                           '급비': '0',
                           '단가': '338',
                           '동반(모든케이스)': True,
                           '처방코드': 'A00421',
                           '청구코드': '650500421',
                           '코드': '650500421',
                           '코드명': '[245]*제일에피네프린주사액',
                           '항목': '0401'},
                          {'case_n': 16,
                           '급비': '3',
                           '단가': '0',
                           '동반(모든케이스)': True,
                           '처방코드': '65310070F',
                           '청구코드': '653100701',
                           '코드': '653100701',
                           '코드명': '[611](OR용-FREE)비씨반코마이신염산염주1g',
                           '항목': '0401'},
                          {'case_n': 16,
                           '급비': '0',
                           '단가': '300',
                           '동반(모든케이스)': True,
                           '처방코드': '653101191',
                           '청구코드': '653101191',
                           '코드': '653101191',
                           '코드명': '[222]아록솔주(암브록솔염산염)_(15mg/2mL)',
                           '항목': '0401'},
                          {'case_n': 16,
                           '급비': '0',
                           '단가': '1,812',
                           '동반(모든케이스)': True,
                           '처방코드': 'A0235',
                           '청구코드': '653402351',
                           '코드': '653402351',
                           '코드명': '[111][향]포폴주사12ml(프로포폴)',
                           '항목': '0401'},
                          {'case_n': 16,
                           '급비': '0',
                           '단가': '3,174',
                           '동반(모든케이스)': True,
                           '처방코드': '65540296',
                           '청구코드': '655402961',
                           '코드': '655402961',
                           '코드명': '[122]로큐메론주50mg/5ml(로쿠로니움브롬화물)',
                           '항목': '0401'},
                          {'case_n': 16,
                           '급비': '1',
                           '단가': '9,954',
                           '동반(모든케이스)': True,
                           '처방코드': '65780228',
                           '청구코드': '657802283',
                           '코드': '657802283',
                           '코드명': '[821][마]하나구연산펜타닐주사(10ml/앰플(P)',
                           '항목': '0401'},
                          {'case_n': 16,
                           '급비': '0',
                           '단가': '5,338',
                           '동반(모든케이스)': True,
                           '처방코드': '65780445',
                           '청구코드': '657804451',
                           '코드': '657804451',
                           '코드명': '[121]로카핀주7.5mg/ml(로피바카인염산염수화물)_(0.158g/20ml)',
                           '항목': '0401'},
                          {'case_n': 16,
                           '급비': '0',
                           '단가': '0',
                           '동반(모든케이스)': True,
                           '처방코드': 'IX',
                           '청구코드': 'IX',
                           '코드': 'IX',
                           '코드명': '수기료 산정안함',
                           '항목': '0401'},
                          {'case_n': 16,
                           '급비': '0',
                           '단가': '3,920',
                           '동반(모든케이스)': True,
                           '처방코드': 'KK053',
                           '청구코드': 'KK053',
                           '코드': 'KK053',
                           '코드명': 'Fluid-501-1000mL',
                           '항목': '0401'}],
           'rules_0801': [{'case_n': 16,
                           '급비': '0',
                           '단가': '1,460',
                           '동반(모든케이스)': True,
                           '처방코드': 'B0003006',
                           '청구코드': 'B0003006',
                           '코드': 'B0003006',
                           '코드명': 'Nylon 3/0 (비즈메디)',
                           '항목': '0801'},
                          {'case_n': 16,
                           '급비': '3',
                           '단가': '12,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'BK7000ZC',
                           '청구코드': 'BK7000ZC',
                           '코드': 'BK7000ZC',
                           '코드명': 'MEDIAS T (아이비메디칼)',
                           '항목': '0801'},
                          {'case_n': 16,
                           '급비': '3',
                           '단가': '4,950',
                           '동반(모든케이스)': True,
                           '처방코드': 'BM2000JI',
                           '청구코드': 'BM2000JI',
                           '코드': 'BM2000JI',
                           '코드명': 'Tape silicone(innomed) 2.5*30cm (비즈메디)',
                           '항목': '0801'},
                          {'case_n': 16,
                           '급비': '3',
                           '단가': '30,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'BM5100DCM',
                           '청구코드': 'BM5100DC',
                           '코드': 'BM5100DC',
                           '코드명': '인성부직반창고 마스크',
                           '항목': '0801'},
                          {'case_n': 16,
                           '급비': '3',
                           '단가': '30,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'BM5101JN',
                           '청구코드': 'BM5100JN',
                           '코드': 'BM5100JN',
                           '코드명': 'VS 밴드 (아이비메디칼)',
                           '항목': '0801'},
                          {'case_n': 16,
                           '급비': '3',
                           '단가': '1,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'BM5100RW',
                           '청구코드': 'BM5100RW',
                           '코드': 'BM5100RW',
                           '코드명': '메디큐어롤반창고4 인치(10*10) (비즈메디)',
                           '항목': '0801'},
                          {'case_n': 16,
                           '급비': 'B',
                           '단가': '54,150',
                           '동반(모든케이스)': True,
                           '처방코드': 'J4306735',
                           '청구코드': 'J4306735',
                           '코드': 'J4306735',
                           '코드명': 'Autofuser K Bolus (PCA )(아이비메디칼)',
                           '항목': '0801'},
                          {'case_n': 16,
                           '급비': '0',
                           '단가': '17,160',
                           '동반(모든케이스)': True,
                           '처방코드': 'K3002304',
                           '청구코드': 'K3002304',
                           '코드': 'K3002304',
                           '코드명': 'Barovac-Pp (세운)',
                           '항목': '0801'},
                          {'case_n': 16,
                           '급비': '0',
                           '단가': '14,820',
                           '동반(모든케이스)': True,
                           '처방코드': 'K4041031',
                           '청구코드': 'K4041031',
                           '코드': 'K4041031',
                           '코드명': 'E-Tube Reinforced Cuffed Type(꺽임방지형)(전규격)(비즈메디)',
                           '항목': '0801'},
                          {'case_n': 16,
                           '급비': '0',
                           '단가': '15,750',
                           '동반(모든케이스)': True,
                           '처방코드': 'K4430035',
                           '청구코드': 'K4430035',
                           '코드': 'K4430035',
                           '코드명': 'ACE BLADE(비전메디)',
                           '항목': '0801'},
                          {'case_n': 16,
                           '급비': 'B',
                           '단가': '57,070',
                           '동반(모든케이스)': True,
                           '처방코드': 'K4501361',
                           '청구코드': 'K4501361',
                           '코드': 'K4501361',
                           '코드명': 'HEATED CIRCUIT',
                           '항목': '0801'},
                          {'case_n': 16,
                           '급비': '3',
                           '단가': '300,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'K9205050',
                           '청구코드': 'K9205050',
                           '코드': 'K9205050',
                           '코드명': 'WOUNDCLOT ABC',
                           '항목': '0801'},
                          {'case_n': 16,
                           '급비': '3',
                           '단가': '100,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'K9205250',
                           '청구코드': 'K9205250',
                           '코드': 'K9205250',
                           '코드명': 'M-Clot [전규격]',
                           '항목': '0801'},
                          {'case_n': 16,
                           '급비': '0',
                           '단가': '7,580',
                           '동반(모든케이스)': True,
                           '처방코드': 'M6610161',
                           '청구코드': 'M6610161',
                           '코드': 'M6610161',
                           '코드명': 'ACE GRIP ENDO FIXⅡ',
                           '항목': '0801'},
                          {'case_n': 16,
                           '급비': 'B',
                           '단가': '1,500',
                           '동반(모든케이스)': True,
                           '처방코드': 'M6710639',
                           '청구코드': 'M6710639',
                           '코드': 'M6710639',
                           '코드명': 'Multifix EF(폴리용)(유치카테터 고정용)(비즈메디)',
                           '항목': '0801'},
                          {'case_n': 16,
                           '급비': '0',
                           '단가': '116,250',
                           '동반(모든케이스)': True,
                           '처방코드': 'N0051006',
                           '청구코드': 'N0051006',
                           '코드': 'N0051006',
                           '코드명': '척추 및 척수수술에 사용한 Burr,Saw 등 절삭기류',
                           '항목': '0801'},
                          {'case_n': 16,
                           '급비': '0',
                           '단가': '615,160',
                           '동반(모든케이스)': True,
                           '처방코드': 'N1499',
                           '청구코드': 'N1499',
                           '코드': 'N1499',
                           '코드명': 'Laminectomy-lumbar(척추후궁절제술-요추)',
                           '항목': '0801'}]},
 'SZ631': {'base_col': '청구코드',
           'case_n_max': 14,
           'rules_0401': [{'case_n': 14,
                           '급비': '0',
                           '단가': '5,338',
                           '동반(모든케이스)': True,
                           '처방코드': '65780445',
                           '청구코드': '657804451',
                           '코드': '657804451',
                           '코드명': '[121]로카핀주7.5mg/ml(로피바카인염산염수화물)_(0.158g/20ml)',
                           '항목': '0401'},
                          {'case_n': 14,
                           '급비': '3',
                           '단가': '50,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'PINJ05',
                           '청구코드': '(PINJ05)',
                           '코드': '(PINJ05)',
                           '코드명': '통증주사',
                           '항목': '0401'},
                          {'case_n': 14,
                           '급비': '3',
                           '단가': '0',
                           '동반(모든케이스)': True,
                           '처방코드': '67060263',
                           '청구코드': '670602631',
                           '코드': '670602631',
                           '코드명': '하이코민주사 2ml(fee free-하부코드전용)',
                           '항목': '0401'},
                          {'case_n': 14,
                           '급비': '3',
                           '단가': '0',
                           '동반(모든케이스)': True,
                           '처방코드': '6932AAP',
                           '청구코드': '681100401',
                           '코드': '681100401',
                           '코드명': '(fee free-하부코드전용)GCW아세트아미노펜주',
                           '항목': '0401'},
                          {'case_n': 14,
                           '급비': '0',
                           '단가': '0',
                           '동반(모든케이스)': True,
                           '처방코드': 'IX',
                           '청구코드': 'IX',
                           '코드': 'IX',
                           '코드명': '수기료 산정안함',
                           '항목': '0401'},
                          {'case_n': 14,
                           '급비': '0',
                           '단가': '3,920',
                           '동반(모든케이스)': True,
                           '처방코드': 'KK053',
                           '청구코드': 'KK053',
                           '코드': 'KK053',
                           '코드명': 'Fluid-501-1000mL',
                           '항목': '0401'},
                          {'case_n': 14,
                           '급비': '0',
                           '단가': '1,440',
                           '동반(모든케이스)': True,
                           '처방코드': 'KK054',
                           '청구코드': 'KK054',
                           '코드': 'KK054',
                           '코드명': 'IV side',
                           '항목': '0401'}],
           'rules_0801': [{'case_n': 14,
                           '급비': '3',
                           '단가': '30,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'BM5100DCN',
                           '청구코드': 'BM5100DC',
                           '코드': 'BM5100DC',
                           '코드명': '인성부직반창고 나잘',
                           '항목': '0801'},
                          {'case_n': 14,
                           '급비': '3',
                           '단가': '0',
                           '동반(모든케이스)': True,
                           '처방코드': 'BJ4802UNF',
                           '청구코드': 'BJ4802UN',
                           '코드': 'BJ4802UN',
                           '코드명': '(EED)Spinaut-V Epidural Catheter-무수가',
                           '항목': '0801'},
                          {'case_n': 14,
                           '급비': '3',
                           '단가': '30,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'BK7000VB',
                           '청구코드': 'BK7000VB',
                           '코드': 'BK7000VB',
                           '코드명': 'BBAND (아이비메디칼)',
                           '항목': '0801'},
                          {'case_n': 14,
                           '급비': '3',
                           '단가': '3,000,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'SZ6313',
                           '청구코드': 'SZ631',
                           '코드': 'SZ631',
                           '코드명': 'EED (내시경적 경막외강 신경감압술)',
                           '항목': '0801'}]},
 'SZ634': {'base_col': '청구코드',
           'case_n_max': 19,
           'rules_0401': [{'case_n': 19,
                           '급비': '0',
                           '단가': '321',
                           '동반(모든케이스)': True,
                           '처방코드': '64490269',
                           '청구코드': '644902691',
                           '코드': '644902691',
                           '코드명': '[331]중외생리식염주사액(20ml)',
                           '항목': '0401'},
                          {'case_n': 19,
                           '급비': '3',
                           '단가': '0',
                           '동반(모든케이스)': True,
                           '처방코드': '6706034A',
                           '청구코드': '(6706034A)',
                           '코드': '(6706034A)',
                           '코드명': '[121]휴온스리도카인1 %20ml(PEN-무수가)',
                           '항목': '0401'},
                          {'case_n': 19,
                           '급비': '3',
                           '단가': '0',
                           '동반(모든케이스)': True,
                           '처방코드': '65780229',
                           '청구코드': '657802271',
                           '코드': '657802271',
                           '코드명': '[마]*하나구연산펜타닐 0.157mg/2ml (PEN-무수가)',
                           '항목': '0401'}],
           'rules_0801': [{'case_n': 19,
                           '급비': '0',
                           '단가': '11',
                           '동반(모든케이스)': True,
                           '처방코드': 'OXY02',
                           '청구코드': '699900020',
                           '코드': '699900020',
                           '코드명': '처치용산소 2L',
                           '항목': '0801'},
                          {'case_n': 19,
                           '급비': '3',
                           '단가': '30,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'BM5100DCN',
                           '청구코드': 'BM5100DC',
                           '코드': 'BM5100DC',
                           '코드명': '인성부직반창고 나잘',
                           '항목': '0801'},
                          {'case_n': 19,
                           '급비': '0',
                           '단가': '8,720',
                           '동반(모든케이스)': True,
                           '처방코드': 'M0040',
                           '청구코드': 'M0040',
                           '코드': 'M0040',
                           '코드명': 'O2 Inhalation(산소흡입)-1일당',
                           '항목': '0801'},
                          {'case_n': 19,
                           '급비': 'B',
                           '단가': '143',
                           '동반(모든케이스)': True,
                           '처방코드': 'M3101027',
                           '청구코드': 'M3101127',
                           '코드': 'M3101127',
                           '코드명': '큐앤큐메딕스밴드 부직포+탈지면패드 6*8 [1호]',
                           '항목': '0801'},
                          {'case_n': 19,
                           '급비': '3',
                           '단가': '1,100,000',
                           '동반(모든케이스)': True,
                           '처방코드': 'SZ634A',
                           '청구코드': 'SZ634',
                           '코드': 'SZ634',
                           '코드명': 'PEN -Lumbar(경피적 경막외강 신경성형술)',
                           '항목': '0801'}]}}

# -----------------------------
# 공통: 복붙 파서
# -----------------------------
EXPECTED_COLS = [
    "선택", "처방코드", "청구코드", "처방명", "항목", "종별가산", "단가", "종별가산단가",
    "1회투", "Tms/Tot Q", "일수", "금액", "급비", "급비지정", "포괄", "완화", "원외", "무료", "처방일자", "항목명"
]
SECTION_ROW_PATTERN = re.compile(r"^\s*\[\s*.+?\s*\]\s*$")  # [ 진찰료 ] 같은 행


def _clean_lines(raw: str) -> str:
    lines = []
    for ln in raw.replace("\r\n", "\n").replace("\r", "\n").splitlines():
        if not ln.strip():
            continue
        if SECTION_ROW_PATTERN.match(ln.strip()):
            continue
        lines.append(ln.lstrip("\t"))
    return "\n".join(lines)


def _normalize_columns(df: pd.DataFrame) -> pd.DataFrame:
    df.columns = [str(c).replace("\ufeff", "").strip() for c in df.columns]
    rename_map = {
        "처방 코드": "처방코드",
        "청구 코드": "청구코드",
        "처방코드 ": "처방코드",
        "청구코드 ": "청구코드",
        "처 방 코 드": "처방코드",
        "청 구 코 드": "청구코드",
        "처방코드(내부)": "처방코드",
        "청구코드(EDI)": "청구코드",
    }
    return df.rename(columns=rename_map)


def parse_clipboard_tsv(raw: str) -> pd.DataFrame:
    cleaned = _clean_lines(raw)
    if not cleaned.strip():
        return pd.DataFrame(columns=EXPECTED_COLS)

    df = pd.read_csv(
        io.StringIO(cleaned),
        sep="\t",
        dtype=str,
        engine="python",
        keep_default_na=False
    )
    df = _normalize_columns(df)

    # 헤더 없을 때 재시도
    if ("처방코드" not in df.columns) and ("청구코드" not in df.columns):
        df2 = pd.read_csv(
            io.StringIO(cleaned),
            sep="\t",
            header=None,
            dtype=str,
            engine="python",
            keep_default_na=False
        )
        df2 = df2.iloc[:, :len(EXPECTED_COLS)]
        df2.columns = EXPECTED_COLS[:df2.shape[1]]
        df = df2
    else:
        for c in EXPECTED_COLS:
            if c not in df.columns:
                df[c] = ""
        df = df[EXPECTED_COLS].copy()

    # 날짜
    df["처방일자"] = df["처방일자"].astype(str).str.strip()
    df["처방일자_dt"] = pd.to_datetime(df["처방일자"], format="%Y%m%d", errors="coerce")

    # 섹션행 제거
    mask_section = df["처방코드"].astype(str).str.strip().str.match(r"^\[.+\]$")
    df = df.loc[~mask_section].copy()

    # 코드 둘 다 비어있는 합계행 제거
    mask_no_codes = (df["처방코드"].astype(str).str.strip() == "") & (df["청구코드"].astype(str).str.strip() == "")
    df = df.loc[~mask_no_codes].copy()

    # 기본 trim
    for c in ["항목", "처방코드", "청구코드", "처방명", "급비", "처방일자"]:
        if c in df.columns:
            df[c] = df[c].astype(str).str.replace("\ufeff", "", regex=False).str.strip()

    return df


# -----------------------------
# 점검 로직
# -----------------------------
def applied_base_codes_by_date(df_case: pd.DataFrame) -> Dict[str, Set[str]]:
    """
    날짜별로, 이번 처방에서 '기준코드'가 실제 등장해서 적용해야 하는 RULES(base_code) 목록을 만든다.
    기준코드는 각 RULES[base_code]['base_col'] 컬럼에서 '항목=0801' 행에 등장한 것으로 판정.
    """
    out: Dict[str, Set[str]] = {}
    if df_case is None or df_case.empty:
        return out

    d = df_case.copy()
    if "처방일자" not in d.columns:
        d["처방일자"] = ""
    d["처방일자"] = d["처방일자"].astype(str).str.strip()
    if "항목" not in d.columns:
        d["항목"] = ""
    d["항목"] = d["항목"].astype(str).str.strip()

    for rx_date, g in d.groupby("처방일자", dropna=False):
        codes_for_date: Set[str] = set()
        for base_code, rule in RULES.items():
            base_col = rule.get("base_col", "청구코드")
            if base_col not in g.columns:
                continue
            base_vals = set(g.loc[g["항목"] == "0801", base_col].astype(str).str.strip().tolist())
            base_vals.discard("")
            if base_code in base_vals:
                codes_for_date.add(base_code)
        if codes_for_date:
            out[str(rx_date)] = codes_for_date
    return out


def build_check_table(
    df_case: pd.DataFrame,
    rx_date: str,
    base_code: str,
    item: str,
    check_col: str,
    show_only_missing: bool
) -> pd.DataFrame:
    """
    item: "0401" or "0801"
    check_col: "청구코드" or "처방코드" (처방 내 존재 여부 판단)
    """
    rule = RULES.get(base_code, {})
    rules_list = rule.get("rules_0401", []) if item == "0401" else rule.get("rules_0801", [])
    if not rules_list:
        return pd.DataFrame(columns=["✓","코드","청구코드","처방코드","코드명","단가","급비","case_n"])

    g = df_case.copy()
    g["처방일자"] = g.get("처방일자", "").astype(str).str.strip()
    g["항목"] = g.get("항목", "").astype(str).str.strip()
    g[check_col] = g.get(check_col, "").astype(str).str.strip()

    dg = g[g["처방일자"] == str(rx_date)].copy()

    obs = set(dg.loc[dg["항목"] == item, check_col].astype(str).str.strip().tolist())
    obs.discard("")

    rows: List[dict] = []
    for r in rules_list:
        code = str(r.get("코드", "")).strip()
        is_present = (code in obs) if code else False
        rows.append({
            "✓": is_present,
            "코드": code,
            "청구코드": str(r.get("청구코드", "")).strip(),
            "처방코드": str(r.get("처방코드", "")).strip(),
            "코드명": str(r.get("코드명", "")).strip(),
            "단가": str(r.get("단가", "")).strip(),
            "급비": str(r.get("급비", "")).strip(),
            "case_n": int(r.get("case_n", 0) or 0),
        })

    out = pd.DataFrame(rows)
    if show_only_missing:
        out = out[out["✓"] == False].copy()
    out = out.sort_values(["✓","case_n","코드"], ascending=[True, False, True]).reset_index(drop=True)
    return out


def summarize_result(check_0401: pd.DataFrame, check_0801: pd.DataFrame) -> dict:
    def _cnt(df: pd.DataFrame):
        if df is None or df.empty:
            return (0, 0)
        total = int(len(df))
        ok = int(df["✓"].sum()) if "✓" in df.columns else 0
        miss = total - ok
        return total, miss

    t40, m40 = _cnt(check_0401)
    t80, m80 = _cnt(check_0801)
    return {
        "0401_total": t40, "0401_missing": m40,
        "0801_total": t80, "0801_missing": m80,
        "total_missing": m40 + m80
    }


# -----------------------------
# UI
# -----------------------------
st.set_page_config(page_title="규칙 누락 점검(하드코딩)", layout="wide")
st.title("규칙결과 하드코딩 버전 → 처방 복붙만으로 0401/0801 점검 (case_n 최빈(최대)값 규칙만)")

with st.sidebar:
    st.subheader("점검 옵션")
    check_col = st.radio("처방에서 ‘있다/없다’ 판단 컬럼", ["청구코드", "처방코드"], index=0)
    show_only_missing = st.toggle("누락만 보기", value=False)
    st.divider()
    st.caption("※ 기준코드는 각 기준코드의 base_col에서 ‘항목=0801’에 등장해야 적용됩니다.")
    st.caption("※ RULES는 규칙결과 엑셀에서 '각 파일의 case_n 최대값'과 동일한 행만 포함해 하드코딩되어 있습니다.")

st.subheader("처방 복붙")
if "rx_raw" not in st.session_state:
    st.session_state["rx_raw"] = ""

cbtn, _ = st.columns([1, 5])
with cbtn:
    if st.button("🧹 입력창 비우기", use_container_width=True):
        st.session_state["rx_raw"] = ""
        st.rerun()

raw = st.text_area("표 그대로 붙여넣기(탭 구분)", height=220, key="rx_raw")

if not raw.strip():
    st.info("처방을 복붙하면 자동으로 기준코드를 판정하고 체크리스트를 보여줍니다.")
    st.stop()

df_case = parse_clipboard_tsv(raw)

# 날짜별 적용 기준코드 판정
applied_by_date = applied_base_codes_by_date(df_case)
applied_codes_all = sorted({c for s in applied_by_date.values() for c in s})

# ✅ 기준코드 목록(이번 복붙 적용 여부 색표시)
with st.expander("기준코드 목록 (이번 복붙에서 적용된 기준코드 색표시)", expanded=True):
    rows = []
    for base_code, rule in sorted(RULES.items(), key=lambda x: x[0]):
        rows.append({
            "기준코드": base_code,
            "base_col": rule.get("base_col",""),
            "case_n_max": rule.get("case_n_max", ""),
            "0401규칙수": len(rule.get("rules_0401", [])),
            "0801규칙수": len(rule.get("rules_0801", [])),
            "이번복붙_적용여부": (base_code in applied_codes_all),
        })
    df_list = pd.DataFrame(rows).sort_values(["이번복붙_적용여부","기준코드"], ascending=[False, True]).reset_index(drop=True)

    def _hl(row):
        return ["background-color:#d1fae5"] * len(row) if bool(row.get("이번복붙_적용여부")) else [""] * len(row)

    st.dataframe(df_list.style.apply(_hl, axis=1), use_container_width=True)
    st.caption("이번 복붙에서 적용된 기준코드: " + (", ".join(applied_codes_all) if applied_codes_all else "(없음)"))

if not applied_by_date:
    st.warning("이번 복붙에서는 어떤 기준코드도(항목=0801 기준) 발견되지 않아 규칙을 적용하지 않았습니다.")
    st.stop()

st.divider()
st.subheader("점검 결과 (날짜 × 기준코드)")

# 날짜별 섹션
for rx_date in sorted(applied_by_date.keys()):
    codes = sorted(applied_by_date[rx_date])
    st.markdown(f"### 처방일자: {rx_date}  |  적용 기준코드: {', '.join(codes)}")

    for base_code in codes:
        colL, colR = st.columns(2)

        # 표시용(누락만 보기 옵션 적용)
        view_0401 = build_check_table(df_case, rx_date, base_code, "0401", check_col, show_only_missing)
        view_0801 = build_check_table(df_case, rx_date, base_code, "0801", check_col, show_only_missing)

        # 요약용(항상 전체 기준)
        full_0401 = build_check_table(df_case, rx_date, base_code, "0401", check_col, False)
        full_0801 = build_check_table(df_case, rx_date, base_code, "0801", check_col, False)
        summary = summarize_result(full_0401, full_0801)

        # ✅ 결론(요약)
        if summary["total_missing"] == 0:
            st.success(f"✅ 기준코드 {base_code}: 누락 없음 (0401 {summary['0401_total']}개 / 0801 {summary['0801_total']}개)")
        else:
            st.error(
                f"⚠️ 기준코드 {base_code}: 누락 {summary['total_missing']}개 "
                f"(0401 누락 {summary['0401_missing']}/{summary['0401_total']}, "
                f"0801 누락 {summary['0801_missing']}/{summary['0801_total']})"
            )

        with colL:
            st.markdown(f"**0401 체크리스트 — 기준코드 {base_code}**")
            st.dataframe(
                view_0401,
                use_container_width=True,
                column_config={
                    "✓": st.column_config.CheckboxColumn("✓", help="현재 처방(해당 날짜)에 존재하면 체크"),
                    "case_n": st.column_config.NumberColumn("case_n"),
                }
            )

        with colR:
            st.markdown(f"**0801 체크리스트 — 기준코드 {base_code}**")
            st.dataframe(
                view_0801,
                use_container_width=True,
                column_config={
                    "✓": st.column_config.CheckboxColumn("✓", help="현재 처방(해당 날짜)에 존재하면 체크"),
                    "case_n": st.column_config.NumberColumn("case_n"),
                }
            )

    st.divider()

# 다운로드(현재 복붙 기준으로, 체크 포함)
st.subheader("다운로드")
out_rows = []
for rx_date, codes in applied_by_date.items():
    for base_code in codes:
        for item in ["0401","0801"]:
            tbl = build_check_table(df_case, rx_date, base_code, item, check_col, False)
            if tbl.empty:
                continue
            tbl2 = tbl.copy()
            tbl2.insert(0, "항목", item)
            tbl2.insert(0, "기준코드", base_code)
            tbl2.insert(0, "처방일자", rx_date)
            out_rows.append(tbl2)

if out_rows:
    out_df = pd.concat(out_rows, ignore_index=True)
    x = io.BytesIO()
    with pd.ExcelWriter(x, engine="openpyxl") as writer:
        out_df.to_excel(writer, index=False, sheet_name="checklist")
    st.download_button(
        "📥 체크리스트 다운로드(Excel)",
        data=x.getvalue(),
        file_name=f"체크리스트_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx",
        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
        use_container_width=True
    )
else:
    st.info("다운로드할 체크리스트가 없습니다.")
